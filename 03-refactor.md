Refactor this code.

Goals:

- Reduce complexity
- Improve readability
- Remove unnecessary state or logic
- Keep behavior unchanged

Constraints:

- Do not introduce new libraries
- Do not add new architectural patterns
